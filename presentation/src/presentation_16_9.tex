%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TUM-Vorlage: Präsentation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Rechteinhaber:
%     Technische Universität München
%     https://www.tum.de
% 
% Gestaltung:
%     ediundsepp Gestaltungsgesellschaft, München
%     http://www.ediundsepp.de
% 
% Technische Umsetzung:
%     eWorks GmbH, Frankfurt am Main
%     http://www.eworks.de
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Zur Wahl des Seitenverhältnisses bitte einen der beiden folgenden Befehle
% auskommentieren und den ausführen lassen:
\input{praeambel_16_9.tex} % Seitenverhältnis 16:9
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{settings.tex}                    % !!! DATEI ANPASSEN !!!
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\Datum}{\today}

\renewcommand{\PraesentationFusszeileZusatz}{Rechnerarchitektur-Großpraktikum 2021 | Statische Binärübersetzung von RISC-V in x86-64}

\title{Statische Binärübersetzung von RISC-V in x86-64}
\author{Lukas Döllerer, Jonathan Hettwer, Johannes Maier, Tobias Schwarz, Felix Solcher}
\institute[]{Rechnerarchitektur-Großpraktikum 2021}
\date[\Datum]{Garching, 16. Juli 2021}
\subject{Statische Binärübersetzung von RISC-V in x86-64}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{entry.tex} % !!! NICHT ENTFERNEN !!!
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FOLIENSTIL: Standard
\PraesentationMasterStandard

\PraesentationTitelseite % Fügt die Startseite ein


% draws an arrow from (#2,#3) to (#2+#4,#3) with height of #5 (arrow in x direction)
% color, startX, startY, length (X dir), height (Y dir)
\newcommand{\TikZArrowX}[5]{
    \filldraw[#1] (#2,#3) -- (#2,#3+#5*2/3) -- (#2+#4/2,#3+#5*2/3) -- (#2+#4/2,#3+#5) -- (#2+#4,#3) -- (#2+#4/2,#3-#5) -- (#2+#4/2,#3-#5*2/3) -- (#2,#3-#5*2/3) -- (#2,#3);
    \draw[#1, black] (#2,#3) -- (#2,#3+#5*2/3) -- (#2+#4/2,#3+#5*2/3) -- (#2+#4/2,#3+#5) -- (#2+#4,#3) -- (#2+#4/2,#3-#5) -- (#2+#4/2,#3-#5*2/3) -- (#2,#3-#5*2/3) -- (#2,#3);
}

% draws an arrow from #2,#3) to (#2,#3+#5) with height of #4 (arrow in y direction)
% color, startX, startY, length (X dir), height (Y dir), color
\newcommand{\TikZArrowY}[5]{
    \filldraw[#1] (#2,#3) -- (#2+#4*2/3,#3) -- (#2+#4*2/3,#3+#5/2) -- (#2+#4,#3+#5/2) -- (#2,#3+#5) -- (#2-#4,#3+#5/2) -- (#2-#4*2/3,#3+#5/2) -- (#2-#4*2/3,#3) -- (#2,#3);
    \draw[#1, black] (#2,#3) -- (#2+#4*2/3,#3) -- (#2+#4*2/3,#3+#5/2) -- (#2+#4,#3+#5/2) -- (#2,#3+#5) -- (#2-#4,#3+#5/2) -- (#2-#4*2/3,#3+#5/2) -- (#2-#4*2/3,#3) -- (#2,#3);
}

% draws one entry of the color legend for the program scheme
% color, text, posX, posY (left, top coordinate)
\newcommand{\colorLegendEntry}[4]{
    \filldraw[#1] (#3,#4) rectangle (#3+1,#4+1);
    \draw[black] (#3,#4) rectangle (#3+1,#4+1);
    \node at (#3+0.5,#4+0.4) (color_legend_entry_point) {};
    \node[right=2mm of color_legend_entry_point] (color_legend_entry_text) {#2};
}

% draws a color legend for the program scheme
% posX, posY (left, top coordinate)
\newcommand{\colorLegend}[2] {
    \colorLegendEntry{TUMOrange}{Main program parts}{#1}{#2}
    \colorLegendEntry{TUMBlauDunkel}{Immediate Representation (IR)}{#1}{#2-1.5}
    \colorLegendEntry{purple}{Maschine Code / ELF File}{#1}{#2-3}
}

% draws the schematic presentation of the program
% scale, fontSize
\newcommand{\ProgramSchemeVersionOne}[2]{
    \begin{center}
        \begin{tikzpicture}[very thick, scale=#1]
            % riscv elf file rectangle
            % background
            \filldraw[purple] (-2,-2) rectangle (2,2);
            % black border
            \draw[black] (-2,-2) rectangle (2,2);
            % label
            \node[align=center] at (0,0) (riscv_text) {\fontsize{#2}{#2} \selectfont RISC-V};

            % lifter arrow
            \TikZArrowX{TUMOrange}{2}{0}{6}{1.5}
            % arrow label
            \node[align=center] at (4.5,0) (lifter_text) {\fontsize{#2}{#2} \selectfont Lifter};

            % ir (unoptimized) rectangle
            % background
            \filldraw[TUMBlauDunkel] (8,-2) rectangle (12,2);
            % black border
            \draw[black] (8,-2) rectangle (12,2);
            % label
            \node[align=center] at (10,0) (ir_text_1) {\fontsize{#2}{#2} \selectfont IR};

            % optimizer arrow
            \TikZArrowX{TUMOrange}{12}{0}{6}{1.5}
            % arrow label
            \node[align=center] at (14.5,0) (optimizer_text) {\fontsize{#2}{#2} \selectfont Optimizer};

            % ir (optimized) rectangle
            % background
            \filldraw[TUMBlauDunkel] (18,-2) rectangle (22,2);
            % black border
            \draw[black] (18,-2) rectangle (22, 2);
            % label
            \node[align=center] at (20,0) (ir_text_2) {\fontsize{#2}{#2} \selectfont IR};

            % compiler arrow
            \TikZArrowX{TUMOrange}{22}{0}{6}{1.5}
            % arrow label
            \node[align=center] at (24.5,0) (compiler_text) {\fontsize{#2}{#2} \selectfont Compiler};

            % x86_64 rectangle
            %background
            \filldraw[purple] (28,-2) rectangle (32,2);
            % black border
            \draw[black] (28,-2) rectangle (32,2);
            % label
            \node[align=center] at (30,0) (x86_64_text) {\fontsize{#2}{#2} \selectfont x86\_64};

            % draw color legend
            \colorLegend{-2}{-6}
        \end{tikzpicture}
    \end{center}
}


\begin{frame}
    \frametitle{Programmübersicht}
    %alignment to have some space between headline an the schematic
    ~\\
    ~\\
    \ProgramSchemeVersionOne{0.6}{18}
\end{frame}

\begin{frame}
    \frametitle{Aufbau der IR}

    \begin{itemize}
        \item Die IR besteht aus mehreren "`Basic Blocks"'
        \item Ein Basic Block besteht aus Eingaben, Variablen in SSA-Form, und Kontrollflussoperationen
    \end{itemize}

    \textbf{Static single assignment (SSA):} Einer Variable wird genau einmal ihr Wert zugewiesen.
    Soll der Wert dieser Variable verändert werden, muss eine neue Variable erstellt werden.
\end{frame}

%%%%%%%%%%%%%%
%% IR Folie %%
%%%%%%%%%%%%%%

\begin{frame}[fragile]
    \frametitle{Intermediate Representation (IR)}
    ~\\
    ~\\
    ~\\
    \begin{columns}[c]
        \column{0.275 \textwidth}
        %\begin{tikzpicture}[scale=2]
        %    \filldraw[TUMOrange] (0,0) rectangle (3.35,3);
        %    \draw[black] (0,0) rectangle (3.35,3);
        %    \node[align=left] at (1.65,1.5) (programm_text) {\fontsize{24}{24} \selectfont \quad [...]\\ \fontsize{24}{24} \selectfont \quad addi a1, x0, 100\\ \fontsize{24}{24} \selectfont loop:\\ \fontsize{24}{24} \selectfont \quad addi a1, a1, -1\\ \fontsize{24}{24} \selectfont \quad bne a1, x0, loop\\ \fontsize{24}{24} \selectfont \quad [...]};
        %\end{tikzpicture}
        \begin{lstlisting}
        [...]
        addi a1, x0, 100
    loop:
        addi a1, a1, -1
        bne a1, x0, loop
        [...]
        \end{lstlisting}

        \column{0.125 \textwidth}
        \begin{tikzpicture}[scale=0.75]
            \TikZArrowX{TUMOrange}{0}{0}{4}{1}
        \end{tikzpicture}

        \column{0.6 \textwidth}
        \begin{lstlisting}
block b1(inputs) <= [predecessors] {
    [...] //statics
    imm v33 <- immediate 0
    imm v34 <- immediate 100
    i64 <- addi i64 v33, i64 v33
} => [(jump, [b2, ...])]

block b2(inputs) <= [predecessors] { // loop
    [...] // statics
    imm v33 <- immediate -1
    i64 v34 <- add i64 v11, i64 v33
} => [(cjump, [b2, ...]), (jump, [...])]
    \end{lstlisting}
    \end{columns}

\end{frame}
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ELF File Parser Folie %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}[fragile]
    \frametitle{Lifter}{ELF Binärdatei laden und Instruktionsbytes decodieren}

    \begin{columns}[c]
        \column{0.5 \textwidth}

        \begin{enumerate}
            \item ELF File prüfen.
            \item Program Header, Sections und Symbole auslesen.
            \item Section Bytes $\rightarrow$ Instruktionen durch \textbf{frvdec} decodieren.
        \end{enumerate}

        \column{0.5 \textwidth}
        \begin{lstlisting}[basicstyle=\tiny, breaklines=true]
        ELF Header:
            Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
            Class:                             ELF64
            Data:                              2's complement, little endian
            Version:                           1 (current)
            OS/ABI:                            UNIX - System V
            ABI Version:                       0
            Type:                              EXEC (Executable file)
            Machine:                           RISC-V
            Version:                           0x1
            Entry point address:               0x100b0
            Start of program headers:          64 (bytes into file)
            Start of section headers:          688 (bytes into file)
            Flags:                             0x5, RVC, double-float ABI
            Size of this header:               64 (bytes)
            Size of program headers:           56 (bytes)
            Number of program headers:         2
            Size of section headers:           64 (bytes)
            Number of section headers:         6
            Section header string table index: 5
        \end{lstlisting}
    \end{columns}
\end{frame}
\clearpage

\note[itemize]{
    \item ELF Prüfung: Prüfbits, System-V ABI, 64-Bit, Little Endian, RISC-V Machine
    \item Symbole weren bei gestrippten ELF-Binaries nicht eingelesen
    \item 32-Byte bzw. 16-Byte Compressed mit frvdec decodieren
}

%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Lifter General Folie %%
%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
    \frametitle{Lifter}{RISC-V Instruktionen in IR Code umwandeln}

    \begin{enumerate}
        \setlength\itemsep{0.6em}
        \item Instruktionen sequenziell lesen:
            \vspace{0.5em}
            \begin{enumerate}
                \setlength\itemsep{0.6em}
                \item Instruktionen in IR parsen.
                \item Wiederhole bis eine \textbf{Kontrollfluss ändernde Instruktion} auftritt.
                \item Beende Basic Block $\rightarrow$ starte neuen Basic Blöck für jede Kontrollflussänderung 
                \item Starte für jeden \textbf{neuen} Basic Block wieder bei 1.
            \end{enumerate}
        \item Sollte Schritt 1 nicht alle vorhandenen Instruktionen in Basic Blöcke gepackt haben:\\ Beginne ab erster unbetrachteter Adresse / Instruktion erneut mit Schritt 1.
    \end{enumerate}
\end{frame}
\clearpage

\note[itemize]{
    \item Rekursives parsen
    \item Start bei ELF Einstiegspunkt
    \item RISC-V Instruktionen sequentiell in IR Instruktionen übertragen
    \item Kontrollfluss-ändernde Instruktionen beenden Basic Blöcke
    \item Alle möglichen Sprungziele starten neue Basic Blöcke
    \item Diese werden rekursiv weiter geliftet
    \item Am Ende gehen wir über alle nicht-geliftete Adressen und starten neue Basic Blöcke
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Lifter Backtracking Folie %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
    \frametitle{Lifter}{Adressbacktracking für indirekte Sprünge}

    \begin{enumerate}
        \setlength\itemsep{0.5em}
        \item JALR und JAL Sprünge legen Befehlzähler in Register x1 $\rightarrow$ "return"
        \item Unbekanntes Sprungziel $\rightarrow$ Backtracking
        \item Backtracking nur für Kontrollfluss im Lifter
    \end{enumerate}
\end{frame}
\clearpage

\note[itemize]{

}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Lifter CfOps Folie %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
    \frametitle{Lifter}{Kontrollflussoperationen}

    \begin{enumerate}
        \setlength\itemsep{0.5em}
        \item System Calls (ecall)
        \begin{itemize}
            \item Schreibt Rückgabewerte auf Statics
        \end{itemize}
        \item Bedingte Sprünge (branch)
        \begin{itemize}
            \item Vergleiche "gleich", "signed lower", "unsigned lower"
            \item Generiert 2 Kontrollflussoperationen
        \end{itemize}
        \item Indirekte Sprünge (jalr)
        \item Direkte Sprünge (jal)
    \end{enumerate}
\end{frame}
\clearpage

\note[itemize]{

}

%%%%%%%%%%%%%%%%%%%%%
%% Generator Folie %%
%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
    \frametitle{Generator}{Übersetztung der IR zu x86\_64}

    \begin{itemize}
        \item Sehr einfache, aber korrekte übersetztung
        \item RISC-V Stack wird simuliert (nicht x86 stack verwendet)
        \item Indirekte Sprünge (RISC-V ret / call) werden per Lookup zur Laufzeit aufgelöst
        \item RISC-V System-V ABI (Startup, Syscall) zur Laufzeit emuliert
        \item Original ELF Programm als binäres speicher bild an exakter addresse eingebunden => no address fixup
        \item First optimizations (eliminate redundant load / store of statics)
    \end{itemize}
\end{frame}
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Technische Demonstration %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}
    \frametitle{Technische Demonstration}{Demonstration des aktuellen Standes}

    % 4-6 Minuten
    % helloworld, helloworld2, fibonacci
    % besser: irgendein program das mit musl libc compiliert ist (im besten falle gzip)
    % + etwas erklären was da geliftet wurde
    % 1. originales program kurz erklären (was es macht, wie es gebaut wurde, andere besonderheiten)
    % 2. originales program ausführen
    % 3. translaten
    % 4. translates program ausführen
\end{frame}
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document} % !!! NICHT ENTFERNEN !!!
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
